# ZXO æˆ’çƒŸæ‰“å¡åº”ç”¨ - äº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆPRDï¼‰

**ç‰ˆæœ¬å·ï¼š** v3.0  
**æœ€åæ›´æ–°ï¼š** 2025å¹´12æœˆ1æ—¥  
**æ–‡æ¡£ç±»å‹ï¼š** äº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆéœ€æ±‚+åŠŸèƒ½æ¸…å•+å‰åç«¯è®¾è®¡ï¼‰

---

## ç›®å½•

1. [äº§å“æ¦‚è¿°](#ä¸€äº§å“æ¦‚è¿°)
2. [åŠŸèƒ½æ¸…å•](#äºŒåŠŸèƒ½æ¸…å•)
3. [ç”¨æˆ·è®¤è¯ç³»ç»Ÿ](#ä¸‰ç”¨æˆ·è®¤è¯ç³»ç»Ÿ)
4. [ç”¨æˆ·ä¸­å¿ƒ](#å››ç”¨æˆ·ä¸­å¿ƒ)
5. [æ‰“å¡ç³»ç»Ÿ](#äº”æ‰“å¡ç³»ç»Ÿ)
6. [æ®µä½ä¸æˆå°±](#å…­æ®µä½ä¸æˆå°±)
7. [çƒŸç˜¾è®°å½•ç³»ç»Ÿ](#ä¸ƒçƒŸç˜¾è®°å½•ç³»ç»Ÿ)
8. [æ’è¡Œæ¦œç³»ç»Ÿ](#å…«æ’è¡Œæ¦œç³»ç»Ÿ)
9. [AI åŠ©æ‰‹ç³»ç»Ÿ](#ä¹ai-åŠ©æ‰‹ç³»ç»Ÿ)
10. [æ”¯ä»˜ç³»ç»Ÿ](#åæ”¯ä»˜ç³»ç»Ÿ)
11. [æ•°æ®æŠ¥å‘Š](#åä¸€æ•°æ®æŠ¥å‘Š)
12. [åˆ†äº«ç³»ç»Ÿ](#åäºŒåˆ†äº«ç³»ç»Ÿ)
13. [æŠ€æœ¯æ¶æ„](#åä¸‰æŠ€æœ¯æ¶æ„)
14. [æ•°æ®åº“è®¾è®¡](#åå››æ•°æ®åº“è®¾è®¡)
15. [API æ¥å£è®¾è®¡](#åäº”api-æ¥å£è®¾è®¡)
16. [éƒ¨ç½²æ–¹æ¡ˆ](#åå…­éƒ¨ç½²æ–¹æ¡ˆ)

---

## ä¸€ã€äº§å“æ¦‚è¿°

### 1.1 äº§å“å®šä½

ZXO æ˜¯ä¸€æ¬¾ä»¥**æ¸¸æˆåŒ–æ®µä½æ™‹å‡**ä¸ºæ ¸å¿ƒçš„æˆ’çƒŸæ‰“å¡å°ç¨‹åº/Web åº”ç”¨ï¼Œé€šè¿‡æ¯æ—¥æ‰“å¡ã€è¡¥ç­¾å¡ç³»ç»Ÿã€9 æ®µä½æ˜Ÿçº§ä½“ç³»ã€çƒŸç˜¾è®°å½•ã€AI åŠ©æ‰‹ã€æ’è¡Œæ¦œç«æŠ€ç­‰åŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·ç§‘å­¦æˆ’çƒŸã€æŒç»­åšæŒã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

- **æ¸¸æˆåŒ–æ¿€åŠ±**ï¼šæ®µä½æ™‹å‡ã€æ˜Ÿçº§ç³»ç»Ÿã€æ’è¡Œæ¦œç«æŠ€
- **ç§‘å­¦æˆ’çƒŸ**ï¼šçƒŸç˜¾è®°å½•æ›²çº¿ã€å¥åº·æŠ¥å‘Šã€AI æ™ºèƒ½è¾…å¯¼
- **ç¤¾äº¤åŠ¨åŠ›**ï¼šæ’è¡Œæ¦œã€åˆ†äº«æµ·æŠ¥ã€å¥½å‹äº’åŠ©
- **å®¹é”™æœºåˆ¶**ï¼šè¡¥ç­¾å¡ç³»ç»Ÿï¼Œé™ä½ä¸­æ–­ç„¦è™‘

### 1.3 ç›®æ ‡ç”¨æˆ·

- **ä¸»è¦ç”¨æˆ·**ï¼š25-45 å²æœ‰æˆ’çƒŸæ„æ„¿çš„æˆå¹´çƒŸæ°‘
- **ä½¿ç”¨åœºæ™¯**ï¼šæ¯æ—¥æ‰“å¡ã€çƒŸç˜¾å‘ä½œè®°å½•ã€æŸ¥çœ‹æ•°æ®æŠ¥å‘Šã€AI å’¨è¯¢
- **æ ¸å¿ƒè¯‰æ±‚**ï¼šåšæŒæ¿€åŠ±ã€æˆæœå¯è§†åŒ–ã€æˆ’çƒŸæŒ‡å¯¼

### 1.4 å•†ä¸šæ¨¡å¼

- **å…è´¹ç”¨æˆ·**ï¼šåŸºç¡€æ‰“å¡ã€æœ¬åœ°æ’å
- **VIP ä¼šå‘˜**ï¼šå…¨å›½æ’åã€4 å¤© AI ä½“éªŒï¼ˆÂ¥9.9/æœˆï¼‰
- **AI æˆ’çƒŸå†›å¸ˆ**ï¼šå®Œæ•´ AI åŠŸèƒ½ï¼ˆÂ¥29.9/æœˆã€Â¥199/å¹´ï¼‰
- **è¡¥ç­¾å¡å•†åŸ**ï¼šå•ç‹¬è´­ä¹°è¡¥ç­¾å¡ï¼ˆÂ¥0.99/å¼ ï¼‰

---

## äºŒã€åŠŸèƒ½æ¸…å•

### 2.1 æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### âœ… å·²å®ŒæˆåŠŸèƒ½

| æ¨¡å— | åŠŸèƒ½ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| **å¼€å±é¡µ** | å“ç‰Œå±•ç¤ºï¼ˆ3ç§’ï¼‰ | P0 | âœ… å·²å®Œæˆ |
| **é¦–é¡µ** | ç”¨æˆ·ä¿¡æ¯å±•ç¤º | P0 | âœ… å·²å®Œæˆ |
| | 6é¡¹æ ¸å¿ƒæ•°æ®å±•ç¤º | P0 | âœ… å·²å®Œæˆ |
| | æ‰“å¡æŒ‰é’® | P0 | âœ… å·²å®Œæˆ |
| | çƒŸç˜¾è®°å½•æŒ‰é’® | P1 | âœ… å·²å®Œæˆ |
| | å¿«æ·å…¥å£ï¼ˆ6ä¸ªï¼‰ | P1 | âœ… å·²å®Œæˆ |
| **é¦–æ¬¡è®¾ç½®** | å¸çƒŸæ•°æ®æ”¶é›† | P0 | âœ… å·²å®Œæˆ |
| | ç”¨æˆ·åè®®åŒæ„ | P0 | âœ… å·²å®Œæˆ |
| **æˆå°±ç­‰çº§é¡µ** | 9æ®µä½ä½“ç³»å±•ç¤º | P1 | âœ… å·²å®Œæˆ |
| | å½“å‰æ®µä½é«˜äº® | P1 | âœ… å·²å®Œæˆ |
| **æ‰“å¡æ—¥å†** | æœˆå†è§†å›¾ | P0 | âœ… å·²å®Œæˆ |
| | è¡¥ç­¾åŠŸèƒ½ | P0 | âœ… å·²å®Œæˆ |
| | è¡¥ç­¾å¡ç®¡ç† | P0 | âœ… å·²å®Œæˆ |
| **åˆ†äº«æµ·æŠ¥** | æˆæœæµ·æŠ¥ç”Ÿæˆ | P1 | âœ… å·²å®Œæˆ |
| | æ’åå±•ç¤ºï¼ˆå·®å¼‚åŒ–ï¼‰ | P1 | âœ… å·²å®Œæˆ |
| | ä¸‹è½½/åˆ†äº« | P1 | âœ… å·²å®Œæˆ |
| **æ•°æ®æŠ¥å‘Š** | çƒŸç˜¾è®°å½•æ›²çº¿ | P1 | âœ… å·²å®Œæˆ |
| | æ—¶æ®µåˆ†å¸ƒç»Ÿè®¡ | P1 | âœ… å·²å®Œæˆ |
| **å¥åº·æŠ¥å‘Š** | å¥åº·æ”¹å–„æ—¶é—´çº¿ | P2 | âœ… å·²å®Œæˆ |
| | é‡Œç¨‹ç¢‘è¾¾æˆå±•ç¤º | P2 | âœ… å·²å®Œæˆ |
| **æ’è¡Œæ¦œ** | æœ¬åœ°æ’åï¼ˆè¡—é“/åŒºï¼‰ | P1 | âœ… å·²å®Œæˆ |
| | å…¨å›½æ’åï¼ˆVIPï¼‰ | P1 | âœ… å·²å®Œæˆ |
| | æƒé™å·®å¼‚åŒ–å±•ç¤º | P1 | âœ… å·²å®Œæˆ |
| **è®¾ç½®é¡µ** | åŸºç¡€ä¿¡æ¯å±•ç¤º | P1 | âœ… å·²å®Œæˆ |
| | ä¿®æ”¹å¸çƒŸæ•°æ® | P1 | âœ… å·²å®Œæˆ |
| | å…‘æ¢ç ç³»ç»Ÿ | P1 | âœ… å·²å®Œæˆ |
| **AI åŠ©æ‰‹** | å¯¹è¯ç•Œé¢ | P2 | âœ… å·²å®Œæˆ |
| | æƒé™æ§åˆ¶ | P2 | âœ… å·²å®Œæˆ |

#### ğŸš§ å¾…å¼€å‘åŠŸèƒ½

| æ¨¡å— | åŠŸèƒ½ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| **ç”¨æˆ·è®¤è¯** | å¾®ä¿¡å°ç¨‹åºç™»å½• | P0 | ğŸš§ å¾…å¼€å‘ |
| | æ‰‹æœºå·ç™»å½• | P2 | ğŸš§ å¾…å¼€å‘ |
| **ç”¨æˆ·ä¸­å¿ƒ** | ä¿®æ”¹å¤´åƒ | P1 | ğŸš§ å¾…å¼€å‘ |
| | ä¿®æ”¹æ˜µç§° | P1 | ğŸš§ å¾…å¼€å‘ |
| | åœ°å€è¯†åˆ«ï¼ˆGPSï¼‰ | P1 | ğŸš§ å¾…å¼€å‘ |
| | æ‰‹åŠ¨é€‰æ‹©åœ°å€ | P2 | ğŸš§ å¾…å¼€å‘ |
| **æ”¯ä»˜ç³»ç»Ÿ** | å¾®ä¿¡æ”¯ä»˜æ¥å…¥ | P0 | ğŸš§ å¾…å¼€å‘ |
| | VIP ä¼šå‘˜è´­ä¹° | P0 | ğŸš§ å¾…å¼€å‘ |
| | AI ä¼šå‘˜è´­ä¹° | P0 | ğŸš§ å¾…å¼€å‘ |
| | è¡¥ç­¾å¡è´­ä¹° | P1 | ğŸš§ å¾…å¼€å‘ |
| | æ”¯ä»˜å›è°ƒå¤„ç† | P0 | ğŸš§ å¾…å¼€å‘ |
| | è®¢å•ç®¡ç† | P1 | ğŸš§ å¾…å¼€å‘ |
| **AI ç³»ç»Ÿ** | DeepSeek æœ¬åœ°éƒ¨ç½² | P1 | ğŸš§ å¾…å¼€å‘ |
| | æç¤ºè¯ä¼˜åŒ– | P1 | ğŸš§ å¾…å¼€å‘ |
| | å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç† | P1 | ğŸš§ å¾…å¼€å‘ |
| **åç«¯åŸºç¡€** | æ•°æ®åº“åˆå§‹åŒ– | P0 | ğŸš§ å¾…å¼€å‘ |
| | API æ¥å£å¼€å‘ | P0 | ğŸš§ å¾…å¼€å‘ |
| | ç¼“å­˜ç³»ç»Ÿæ­å»º | P1 | ğŸš§ å¾…å¼€å‘ |
| | æ¶ˆæ¯é˜Ÿåˆ—æ­å»º | P2 | ğŸš§ å¾…å¼€å‘ |

#### ğŸ’¡ æœªæ¥è§„åˆ’

| æ¨¡å— | åŠŸèƒ½ | ä¼˜å…ˆçº§ | è®¡åˆ’ç‰ˆæœ¬ |
|------|------|--------|----------|
| **ç¤¾äº¤åŠŸèƒ½** | å¥½å‹ç³»ç»Ÿ | P2 | v3.5 |
| | äº’ç›¸ç›‘ç£ | P2 | v3.5 |
| | æˆ’çƒŸæ—¥è®° | P3 | v4.0 |
| **æˆå°±ç³»ç»Ÿ** | å¾½ç« æ”¶é›† | P2 | v3.5 |
| | ç§°å·ç³»ç»Ÿ | P3 | v4.0 |
| **æ•°æ®åˆ†æ** | ä¸ªæ€§åŒ–æ¨è | P2 | v4.0 |
| | çƒŸç˜¾é¢„æµ‹ | P3 | v4.0 |
| **çº¿ä¸‹æ´»åŠ¨** | æˆ’çƒŸæŒ‘æˆ˜èµ› | P3 | v5.0 |

---

## ä¸‰ã€ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

### 3.1 å¾®ä¿¡å°ç¨‹åºç™»å½•

#### 3.1.1 åŠŸèƒ½æè¿°

- ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºæˆæƒç™»å½•
- è·å–ç”¨æˆ· openid ä½œä¸ºå”¯ä¸€æ ‡è¯†
- è‡ªåŠ¨è·å–å¾®ä¿¡å¤´åƒå’Œæ˜µç§°ï¼ˆç”¨æˆ·æˆæƒåï¼‰
- ç”Ÿæˆ JWT Token ç”¨äºåç»­è¯·æ±‚

#### 3.1.2 ç™»å½•æµç¨‹

```
ç”¨æˆ·æ‰“å¼€å°ç¨‹åº
  â†“
è°ƒç”¨ wx.login() è·å– code
  â†“
å‰ç«¯å‘é€ code åˆ°åç«¯
  â†“
åç«¯è°ƒç”¨å¾®ä¿¡ API è·å– openid
  â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æ³¨å†Œ
  â”œâ”€â”€ å·²æ³¨å†Œ â†’ è¿”å›ç”¨æˆ·ä¿¡æ¯ + JWT Token
  â””â”€â”€ æœªæ³¨å†Œ â†’ åˆ›å»ºæ–°ç”¨æˆ· â†’ è¿”å›ä¿¡æ¯ + JWT Token
  â†“
å‰ç«¯å­˜å‚¨ Token
  â†“
è¿›å…¥é¦–é¡µ
```

#### 3.1.3 å‰ç«¯å®ç°

**å°ç¨‹åºç«¯ï¼ˆWeChat Mini Programï¼‰**

```javascript
// pages/login/login.js
Page({
  onLoad() {
    this.wxLogin();
  },

  // å¾®ä¿¡ç™»å½•
  async wxLogin() {
    try {
      // 1. è·å– code
      const { code } = await wx.login();
      
      // 2. å‘é€åˆ°åç«¯
      const res = await wx.request({
        url: 'https://api.zxo.app/v1/auth/wechat/login',
        method: 'POST',
        data: { code }
      });
      
      const { token, user } = res.data.data;
      
      // 3. å­˜å‚¨ Token
      wx.setStorageSync('token', token);
      wx.setStorageSync('user', user);
      
      // 4. è·³è½¬é¦–é¡µ
      wx.switchTab({ url: '/pages/home/home' });
      
    } catch (error) {
      wx.showToast({ title: 'ç™»å½•å¤±è´¥', icon: 'none' });
    }
  },

  // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ç”¨æˆ·ç‚¹å‡»æˆæƒï¼‰
  async getUserProfile() {
    try {
      const { userInfo } = await wx.getUserProfile({
        desc: 'ç”¨äºå®Œå–„ä¸ªäººèµ„æ–™'
      });
      
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      await wx.request({
        url: 'https://api.zxo.app/v1/users/me',
        method: 'PUT',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        },
        data: {
          nickname: userInfo.nickName,
          avatar: userInfo.avatarUrl
        }
      });
      
      wx.showToast({ title: 'æˆæƒæˆåŠŸ' });
      
    } catch (error) {
      wx.showToast({ title: 'æˆæƒå¤±è´¥', icon: 'none' });
    }
  }
});
```

**Web ç«¯ï¼ˆæ‰«ç ç™»å½•ï¼‰**

```typescript
// ç”Ÿæˆç™»å½•äºŒç»´ç 
async function generateQRCode() {
  const res = await fetch('/api/auth/wechat/qrcode');
  const { ticket, qrCodeUrl } = await res.json();
  
  // æ˜¾ç¤ºäºŒç»´ç 
  document.getElementById('qrcode').src = qrCodeUrl;
  
  // è½®è¯¢æ£€æŸ¥ç™»å½•çŠ¶æ€
  const pollInterval = setInterval(async () => {
    const statusRes = await fetch(`/api/auth/wechat/status?ticket=${ticket}`);
    const { status, token, user } = await statusRes.json();
    
    if (status === 'confirmed') {
      clearInterval(pollInterval);
      localStorage.setItem('token', token);
      localStorage.setItem('user', JSON.stringify(user));
      window.location.href = '/home';
    }
  }, 2000);
}
```

#### 3.1.4 åç«¯å®ç°

**API æ¥å£**

```typescript
// POST /api/v1/auth/wechat/login
import axios from 'axios';
import jwt from 'jsonwebtoken';

interface WechatLoginRequest {
  code: string;
  nickname?: string;
  avatar?: string;
}

async function wechatLogin(req, res) {
  const { code, nickname, avatar } = req.body;
  
  try {
    // 1. è°ƒç”¨å¾®ä¿¡ API è·å– openid
    const wxRes = await axios.get('https://api.weixin.qq.com/sns/jscode2session', {
      params: {
        appid: process.env.WECHAT_APP_ID,
        secret: process.env.WECHAT_APP_SECRET,
        js_code: code,
        grant_type: 'authorization_code'
      }
    });
    
    const { openid, session_key, unionid } = wxRes.data;
    
    if (!openid) {
      return res.status(400).json({ code: 400, message: 'ç™»å½•å¤±è´¥' });
    }
    
    // 2. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    let user = await db.users.findOne({ where: { openid } });
    
    if (!user) {
      // åˆ›å»ºæ–°ç”¨æˆ·
      user = await db.users.create({
        openid,
        unionid,
        nickname: nickname || 'æˆ’çƒŸå‹‡å£«',
        avatar: avatar || 'https://zxo.app/default-avatar.png',
        memberType: 'free',
        makeupCards: 3,  // åˆå§‹èµ é€ 3 å¼ è¡¥ç­¾å¡
        totalDays: 0,
        consecutiveDays: 0,
        hasAgreedTerms: false
      });
    } else {
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœæä¾›äº†ï¼‰
      if (nickname || avatar) {
        await db.users.update(user.id, {
          nickname: nickname || user.nickname,
          avatar: avatar || user.avatar
        });
        user = await db.users.findById(user.id);
      }
    }
    
    // 3. ç”Ÿæˆ JWT Token
    const token = jwt.sign(
      {
        userId: user.id,
        openid: user.openid,
        memberType: user.memberType
      },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    );
    
    // 4. è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œ Token
    res.json({
      code: 200,
      data: {
        token,
        user: {
          id: user.id,
          nickname: user.nickname,
          avatar: user.avatar,
          memberType: user.memberType,
          totalDays: user.totalDays,
          consecutiveDays: user.consecutiveDays,
          makeupCards: user.makeupCards
        }
      }
    });
    
  } catch (error) {
    logger.error('å¾®ä¿¡ç™»å½•å¤±è´¥', error);
    res.status(500).json({ code: 500, message: 'ç™»å½•å¤±è´¥' });
  }
}
```

**æ•°æ®åº“è¡¨ç»“æ„**

```sql
-- ç”¨æˆ·è¡¨æ·»åŠ å¾®ä¿¡ç›¸å…³å­—æ®µ
ALTER TABLE users ADD COLUMN openid VARCHAR(128) UNIQUE;
ALTER TABLE users ADD COLUMN unionid VARCHAR(128);
ALTER TABLE users ADD COLUMN session_key VARCHAR(128);
ALTER TABLE users ADD COLUMN wechat_nickname VARCHAR(100);
ALTER TABLE users ADD COLUMN wechat_avatar VARCHAR(500);

CREATE INDEX idx_users_openid ON users(openid);
CREATE INDEX idx_users_unionid ON users(unionid);
```

### 3.2 æ‰‹æœºå·ç™»å½•ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰

#### 3.2.1 åŠŸèƒ½æè¿°

- æ”¯æŒæ‰‹æœºå· + éªŒè¯ç ç™»å½•
- ç”¨äº Web ç«¯æˆ–ä¸ä½¿ç”¨å¾®ä¿¡çš„ç”¨æˆ·

#### 3.2.2 ç™»å½•æµç¨‹

```
ç”¨æˆ·è¾“å…¥æ‰‹æœºå·
  â†“
ç‚¹å‡»"è·å–éªŒè¯ç "
  â†“
åç«¯å‘é€çŸ­ä¿¡éªŒè¯ç 
  â†“
ç”¨æˆ·è¾“å…¥éªŒè¯ç 
  â†“
åç«¯éªŒè¯éªŒè¯ç 
  â†“
ç™»å½•æˆåŠŸï¼Œè¿”å› Token
```

#### 3.2.3 API æ¥å£

```typescript
// POST /api/v1/auth/sms/send
async function sendSmsCode(req, res) {
  const { phone } = req.body;
  
  // 1. éªŒè¯æ‰‹æœºå·æ ¼å¼
  if (!/^1[3-9]\d{9}$/.test(phone)) {
    return res.status(400).json({ code: 400, message: 'æ‰‹æœºå·æ ¼å¼é”™è¯¯' });
  }
  
  // 2. æ£€æŸ¥å‘é€é¢‘ç‡ï¼ˆ60ç§’é™åˆ¶ï¼‰
  const lastSendTime = await redis.get(`sms:${phone}:last_send`);
  if (lastSendTime && Date.now() - parseInt(lastSendTime) < 60000) {
    return res.status(429).json({ code: 429, message: 'è¯·å‹¿é¢‘ç¹å‘é€' });
  }
  
  // 3. ç”Ÿæˆ 6 ä½éªŒè¯ç 
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  
  // 4. å­˜å‚¨éªŒè¯ç ï¼ˆ5 åˆ†é’Ÿæœ‰æ•ˆï¼‰
  await redis.setex(`sms:${phone}:code`, 300, code);
  await redis.set(`sms:${phone}:last_send`, Date.now().toString());
  
  // 5. è°ƒç”¨çŸ­ä¿¡æœåŠ¡å‘é€
  await smsService.send(phone, {
    template: 'login',
    params: { code }
  });
  
  res.json({ code: 200, message: 'éªŒè¯ç å·²å‘é€' });
}

// POST /api/v1/auth/sms/login
async function smsLogin(req, res) {
  const { phone, code } = req.body;
  
  // 1. éªŒè¯éªŒè¯ç 
  const storedCode = await redis.get(`sms:${phone}:code`);
  if (!storedCode || storedCode !== code) {
    return res.status(400).json({ code: 400, message: 'éªŒè¯ç é”™è¯¯' });
  }
  
  // 2. åˆ é™¤éªŒè¯ç 
  await redis.del(`sms:${phone}:code`);
  
  // 3. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
  let user = await db.users.findOne({ where: { phone } });
  
  if (!user) {
    user = await db.users.create({
      phone,
      nickname: `ç”¨æˆ·${phone.slice(-4)}`,
      avatar: 'https://zxo.app/default-avatar.png',
      memberType: 'free',
      makeupCards: 3
    });
  }
  
  // 4. ç”Ÿæˆ Token
  const token = jwt.sign(
    { userId: user.id, memberType: user.memberType },
    process.env.JWT_SECRET,
    { expiresIn: '7d' }
  );
  
  res.json({
    code: 200,
    data: { token, user }
  });
}
```

---

## å››ã€ç”¨æˆ·ä¸­å¿ƒ

### 4.1 ä¿®æ”¹å¤´åƒ

#### 4.1.1 åŠŸèƒ½æè¿°

- ç”¨æˆ·å¯ä»¥ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ
- æ”¯æŒå›¾ç‰‡è£å‰ªï¼ˆ1:1 æ¯”ä¾‹ï¼‰
- ä¸Šä¼ åˆ° OSS äº‘å­˜å‚¨
- è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾

#### 4.1.2 å‰ç«¯å®ç°

**å°ç¨‹åºç«¯**

```javascript
// é€‰æ‹©å¹¶ä¸Šä¼ å¤´åƒ
async function chooseAvatar() {
  try {
    // 1. é€‰æ‹©å›¾ç‰‡
    const { tempFilePaths } = await wx.chooseImage({
      count: 1,
      sizeType: ['compressed'],
      sourceType: ['album', 'camera']
    });
    
    const tempFilePath = tempFilePaths[0];
    
    // 2. ä¸Šä¼ åˆ°åç«¯
    wx.uploadFile({
      url: 'https://api.zxo.app/v1/upload/avatar',
      filePath: tempFilePath,
      name: 'avatar',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        const { avatarUrl } = JSON.parse(res.data).data;
        
        // 3. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        this.setData({ avatar: avatarUrl });
        wx.showToast({ title: 'å¤´åƒå·²æ›´æ–°' });
      },
      fail: () => {
        wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' });
      }
    });
    
  } catch (error) {
    console.error('é€‰æ‹©å¤´åƒå¤±è´¥', error);
  }
}
```

**Web ç«¯ï¼ˆå¸¦è£å‰ªï¼‰**

```typescript
import Cropper from 'cropperjs';

function initAvatarUpload() {
  const input = document.getElementById('avatar-input') as HTMLInputElement;
  const img = document.getElementById('crop-image') as HTMLImageElement;
  let cropper: Cropper;
  
  input.addEventListener('change', (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (!file) return;
    
    // æ˜¾ç¤ºè£å‰ªå™¨
    const reader = new FileReader();
    reader.onload = (event) => {
      img.src = event.target?.result as string;
      
      // åˆå§‹åŒ–è£å‰ªå™¨
      cropper = new Cropper(img, {
        aspectRatio: 1,
        viewMode: 1,
        autoCropArea: 1
      });
    };
    reader.readAsDataURL(file);
  });
  
  // ç¡®è®¤è£å‰ª
  document.getElementById('crop-confirm')?.addEventListener('click', async () => {
    const canvas = cropper.getCroppedCanvas({ width: 200, height: 200 });
    
    canvas.toBlob(async (blob) => {
      const formData = new FormData();
      formData.append('avatar', blob!, 'avatar.jpg');
      
      const res = await fetch('/api/v1/upload/avatar', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
      });
      
      const { avatarUrl } = await res.json();
      
      // æ›´æ–°å¤´åƒ
      document.getElementById('user-avatar').src = avatarUrl;
      alert('å¤´åƒå·²æ›´æ–°');
    });
  });
}
```

#### 4.1.3 åç«¯å®ç°

```typescript
import multer from 'multer';
import sharp from 'sharp';
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';

// é…ç½® multerï¼ˆå†…å­˜å­˜å‚¨ï¼‰
const upload = multer({ storage: multer.memoryStorage() });

// é…ç½® S3ï¼ˆæˆ–é˜¿é‡Œäº‘ OSSï¼‰
const s3Client = new S3Client({
  region: process.env.OSS_REGION,
  credentials: {
    accessKeyId: process.env.OSS_ACCESS_KEY_ID,
    secretAccessKey: process.env.OSS_ACCESS_KEY_SECRET
  }
});

// POST /api/v1/upload/avatar
app.post('/upload/avatar', requireAuth, upload.single('avatar'), async (req, res) => {
  try {
    const userId = req.user.id;
    const file = req.file;
    
    if (!file) {
      return res.status(400).json({ code: 400, message: 'æœªä¸Šä¼ æ–‡ä»¶' });
    }
    
    // 1. å›¾ç‰‡å¤„ç†ï¼ˆå‹ç¼©ã€è£å‰ªï¼‰
    const processedImage = await sharp(file.buffer)
      .resize(200, 200, { fit: 'cover' })
      .jpeg({ quality: 90 })
      .toBuffer();
    
    // 2. ç”Ÿæˆæ–‡ä»¶å
    const filename = `avatars/${userId}_${Date.now()}.jpg`;
    
    // 3. ä¸Šä¼ åˆ° OSS
    await s3Client.send(new PutObjectCommand({
      Bucket: process.env.OSS_BUCKET,
      Key: filename,
      Body: processedImage,
      ContentType: 'image/jpeg',
      ACL: 'public-read'
    }));
    
    // 4. ç”Ÿæˆ CDN URL
    const avatarUrl = `https://cdn.zxo.app/${filename}`;
    
    // 5. æ›´æ–°æ•°æ®åº“
    await db.users.update(userId, { avatar: avatarUrl });
    
    // 6. åˆ é™¤ç¼“å­˜
    await redis.del(`user:${userId}`);
    
    res.json({
      code: 200,
      data: { avatarUrl }
    });
    
  } catch (error) {
    logger.error('ä¸Šä¼ å¤´åƒå¤±è´¥', error);
    res.status(500).json({ code: 500, message: 'ä¸Šä¼ å¤±è´¥' });
  }
});
```

### 4.2 ä¿®æ”¹æ˜µç§°

#### 4.2.1 åŠŸèƒ½æè¿°

- ç”¨æˆ·å¯ä»¥ä¿®æ”¹æ˜µç§°
- æ˜µç§°é•¿åº¦é™åˆ¶ï¼š2-20 ä¸ªå­—ç¬¦
- è¿‡æ»¤æ•æ„Ÿè¯
- åŒä¸€ç”¨æˆ·æ¯å¤©æœ€å¤šä¿®æ”¹ 3 æ¬¡

#### 4.2.2 å‰ç«¯å®ç°

```typescript
async function updateNickname(newNickname: string) {
  // 1. å‰ç«¯éªŒè¯
  if (newNickname.length < 2 || newNickname.length > 20) {
    toast.error('æ˜µç§°é•¿åº¦ä¸º 2-20 ä¸ªå­—ç¬¦');
    return;
  }
  
  try {
    // 2. å‘é€è¯·æ±‚
    const res = await fetch('/api/v1/users/me', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getToken()}`
      },
      body: JSON.stringify({ nickname: newNickname })
    });
    
    const data = await res.json();
    
    if (data.code === 200) {
      // æ›´æ–°æœ¬åœ°å­˜å‚¨
      const user = JSON.parse(localStorage.getItem('user'));
      user.nickname = newNickname;
      localStorage.setItem('user', JSON.stringify(user));
      
      toast.success('æ˜µç§°å·²æ›´æ–°');
    } else if (data.code === 429) {
      toast.error('ä»Šæ—¥ä¿®æ”¹æ¬¡æ•°å·²è¾¾ä¸Šé™');
    } else {
      toast.error(data.message);
    }
    
  } catch (error) {
    toast.error('ä¿®æ”¹å¤±è´¥');
  }
}
```

#### 4.2.3 åç«¯å®ç°

```typescript
// PUT /api/v1/users/me
import Filter from 'bad-words';

const filter = new Filter();

async function updateUserInfo(req, res) {
  const userId = req.user.id;
  const { nickname, avatar } = req.body;
  
  try {
    const updates: any = {};
    
    // 1. å¤„ç†æ˜µç§°
    if (nickname !== undefined) {
      // éªŒè¯é•¿åº¦
      if (nickname.length < 2 || nickname.length > 20) {
        return res.status(400).json({ code: 400, message: 'æ˜µç§°é•¿åº¦ä¸º 2-20 ä¸ªå­—ç¬¦' });
      }
      
      // è¿‡æ»¤æ•æ„Ÿè¯
      if (filter.isProfane(nickname)) {
        return res.status(400).json({ code: 400, message: 'æ˜µç§°åŒ…å«æ•æ„Ÿè¯' });
      }
      
      // æ£€æŸ¥ä¿®æ”¹æ¬¡æ•°é™åˆ¶
      const today = new Date().toISOString().split('T')[0];
      const changeCountKey = `nickname_change:${userId}:${today}`;
      const changeCount = await redis.get(changeCountKey);
      
      if (changeCount && parseInt(changeCount) >= 3) {
        return res.status(429).json({ code: 429, message: 'ä»Šæ—¥ä¿®æ”¹æ¬¡æ•°å·²è¾¾ä¸Šé™' });
      }
      
      updates.nickname = nickname;
      
      // å¢åŠ ä¿®æ”¹æ¬¡æ•°
      await redis.incr(changeCountKey);
      await redis.expire(changeCountKey, 86400); // 24 å°æ—¶è¿‡æœŸ
    }
    
    // 2. å¤„ç†å¤´åƒ
    if (avatar !== undefined) {
      updates.avatar = avatar;
    }
    
    // 3. æ›´æ–°æ•°æ®åº“
    await db.users.update(userId, updates);
    
    // 4. åˆ é™¤ç¼“å­˜
    await redis.del(`user:${userId}`);
    
    // 5. è¿”å›æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯
    const user = await db.users.findById(userId);
    
    res.json({
      code: 200,
      data: { user }
    });
    
  } catch (error) {
    logger.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥', error);
    res.status(500).json({ code: 500, message: 'æ›´æ–°å¤±è´¥' });
  }
}
```

### 4.3 åœ°å€è¯†åˆ«ï¼ˆç”¨äºæ’è¡Œæ¦œï¼‰

#### 4.3.1 åŠŸèƒ½æè¿°

- è‡ªåŠ¨è·å–ç”¨æˆ· GPS ä½ç½®
- è°ƒç”¨é«˜å¾·/è…¾è®¯åœ°å›¾ API é€†åœ°ç†ç¼–ç 
- è¯†åˆ«çœã€å¸‚ã€åŒºã€è¡—é“
- ç”¨äºæ’è¡Œæ¦œåˆ†çº§å±•ç¤º
- æ”¯æŒæ‰‹åŠ¨é€‰æ‹©åœ°å€

#### 4.3.2 å‰ç«¯å®ç°

**å°ç¨‹åºç«¯ï¼ˆGPS å®šä½ï¼‰**

```javascript
// è·å–å½“å‰ä½ç½®
async function getLocation() {
  try {
    // 1. è·å–ç”¨æˆ·æˆæƒ
    const { authSetting } = await wx.getSetting();
    
    if (!authSetting['scope.userLocation']) {
      await wx.authorize({ scope: 'scope.userLocation' });
    }
    
    // 2. è·å–ä½ç½®ä¿¡æ¯
    const { latitude, longitude } = await wx.getLocation({
      type: 'gcj02'  // å›½æµ‹å±€åæ ‡
    });
    
    // 3. é€†åœ°ç†ç¼–ç ï¼ˆè°ƒç”¨åç«¯ï¼‰
    const res = await wx.request({
      url: 'https://api.zxo.app/v1/location/geocode',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      data: { latitude, longitude }
    });
    
    const { province, city, district, street, address } = res.data.data;
    
    // 4. æ›´æ–°ç”¨æˆ·åœ°å€
    await wx.request({
      url: 'https://api.zxo.app/v1/users/me/location',
      method: 'PUT',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      data: { province, city, district, street }
    });
    
    wx.showToast({ title: 'å®šä½æˆåŠŸ' });
    
  } catch (error) {
    console.error('å®šä½å¤±è´¥', error);
    wx.showModal({
      title: 'å®šä½å¤±è´¥',
      content: 'è¯·å‰å¾€è®¾ç½®æ‰‹åŠ¨é€‰æ‹©åœ°å€',
      confirmText: 'å»è®¾ç½®'
    });
  }
}
```

**æ‰‹åŠ¨é€‰æ‹©åœ°å€**

```javascript
// åœ°å€é€‰æ‹©å™¨
Page({
  data: {
    provinces: [],
    cities: [],
    districts: [],
    streets: [],
    selectedProvince: '',
    selectedCity: '',
    selectedDistrict: '',
    selectedStreet: ''
  },

  onLoad() {
    this.loadProvinces();
  },

  // åŠ è½½çœä»½åˆ—è¡¨
  async loadProvinces() {
    const res = await wx.request({
      url: 'https://api.zxo.app/v1/location/provinces'
    });
    this.setData({ provinces: res.data.data });
  },

  // é€‰æ‹©çœä»½
  async onProvinceChange(e) {
    const province = e.detail.value;
    this.setData({ selectedProvince: province });
    
    // åŠ è½½åŸå¸‚åˆ—è¡¨
    const res = await wx.request({
      url: `https://api.zxo.app/v1/location/cities?province=${province}`
    });
    this.setData({ cities: res.data.data });
  },

  // é€‰æ‹©åŸå¸‚ï¼ˆç±»ä¼¼ï¼‰
  async onCityChange(e) {
    // ...
  },

  // ç¡®è®¤é€‰æ‹©
  async confirmAddress() {
    const { selectedProvince, selectedCity, selectedDistrict, selectedStreet } = this.data;
    
    await wx.request({
      url: 'https://api.zxo.app/v1/users/me/location',
      method: 'PUT',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      data: {
        province: selectedProvince,
        city: selectedCity,
        district: selectedDistrict,
        street: selectedStreet
      }
    });
    
    wx.navigateBack();
  }
});
```

#### 4.3.3 åç«¯å®ç°

**é€†åœ°ç†ç¼–ç **

```typescript
import axios from 'axios';

// POST /api/v1/location/geocode
async function reverseGeocode(req, res) {
  const { latitude, longitude } = req.body;
  const userId = req.user.id;
  
  try {
    // 1. è°ƒç”¨é«˜å¾·åœ°å›¾ API
    const amapRes = await axios.get('https://restapi.amap.com/v3/geocode/regeo', {
      params: {
        key: process.env.AMAP_API_KEY,
        location: `${longitude},${latitude}`,
        extensions: 'all'
      }
    });
    
    const addressComponent = amapRes.data.regeocode.addressComponent;
    
    const location = {
      province: addressComponent.province,
      city: addressComponent.city || addressComponent.province,  // ç›´è¾–å¸‚å¤„ç†
      district: addressComponent.district,
      street: addressComponent.township,
      address: amapRes.data.regeocode.formatted_address,
      latitude,
      longitude
    };
    
    // 2. æ›´æ–°ç”¨æˆ·åœ°å€
    await db.users.update(userId, {
      province: location.province,
      city: location.city,
      district: location.district,
      street: location.street
    });
    
    // 3. åˆ é™¤ç¼“å­˜
    await redis.del(`user:${userId}`);
    
    res.json({
      code: 200,
      data: location
    });
    
  } catch (error) {
    logger.error('é€†åœ°ç†ç¼–ç å¤±è´¥', error);
    res.status(500).json({ code: 500, message: 'å®šä½å¤±è´¥' });
  }
}

// PUT /api/v1/users/me/location
async function updateUserLocation(req, res) {
  const userId = req.user.id;
  const { province, city, district, street } = req.body;
  
  try {
    await db.users.update(userId, {
      province,
      city,
      district,
      street
    });
    
    // åˆ é™¤ç¼“å­˜
    await redis.del(`user:${userId}`);
    
    // é‡æ–°è®¡ç®—æ’å
    await rankingQueue.add('update-user-ranking', { userId });
    
    res.json({ code: 200, message: 'åœ°å€å·²æ›´æ–°' });
    
  } catch (error) {
    logger.error('æ›´æ–°åœ°å€å¤±è´¥', error);
    res.status(500).json({ code: 500, message: 'æ›´æ–°å¤±è´¥' });
  }
}
```

**åœ°å€æ•°æ®æ¥å£**

```typescript
// ä¸­å›½è¡Œæ”¿åŒºåˆ’æ•°æ®ï¼ˆå¯ä½¿ç”¨å¼€æºæ•°æ®åº“ï¼‰
// https://github.com/modood/Administrative-divisions-of-China

// GET /api/v1/location/provinces
async function getProvinces(req, res) {
  const provinces = await db.query(`
    SELECT DISTINCT province FROM china_regions ORDER BY province
  `);
  res.json({ code: 200, data: provinces });
}

// GET /api/v1/location/cities?province=åŒ—äº¬å¸‚
async function getCities(req, res) {
  const { province } = req.query;
  const cities = await db.query(`
    SELECT DISTINCT city FROM china_regions WHERE province = $1 ORDER BY city
  `, [province]);
  res.json({ code: 200, data: cities });
}

// GET /api/v1/location/districts?city=åŒ—äº¬å¸‚
async function getDistricts(req, res) {
  const { city } = req.query;
  const districts = await db.query(`
    SELECT DISTINCT district FROM china_regions WHERE city = $1 ORDER BY district
  `, [city]);
  res.json({ code: 200, data: districts });
}

// GET /api/v1/location/streets?district=æœé˜³åŒº
async function getStreets(req, res) {
  const { district } = req.query;
  const streets = await db.query(`
    SELECT DISTINCT street FROM china_regions WHERE district = $1 ORDER BY street
  `, [district]);
  res.json({ code: 200, data: streets });
}
```

**æ•°æ®åº“è¡¨**

```sql
-- ä¸­å›½è¡Œæ”¿åŒºåˆ’è¡¨
CREATE TABLE china_regions (
  id SERIAL PRIMARY KEY,
  province VARCHAR(50) NOT NULL,
  city VARCHAR(50) NOT NULL,
  district VARCHAR(50) NOT NULL,
  street VARCHAR(100),
  adcode VARCHAR(20),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_region_province ON china_regions(province);
CREATE INDEX idx_region_city ON china_regions(city);
CREATE INDEX idx_region_district ON china_regions(district);
```

---

## äº”ã€æ‰“å¡ç³»ç»Ÿ

ï¼ˆæ­¤éƒ¨åˆ†å†…å®¹ä¸ä¹‹å‰ PRD ä¸€è‡´ï¼Œç•¥ï¼‰

è¯¦ç»†å†…å®¹å‚è€ƒï¼š
- æ‰“å¡è§„åˆ™
- è¡¥ç­¾æœºåˆ¶
- æ®µä½æ™‹å‡
- è¿ç»­æ‰“å¡å¥–åŠ±

---

## å…­ã€æ®µä½ä¸æˆå°±

ï¼ˆæ­¤éƒ¨åˆ†å†…å®¹ä¸ä¹‹å‰ PRD ä¸€è‡´ï¼Œç•¥ï¼‰

è¯¦ç»†å†…å®¹å‚è€ƒï¼š
- 9 æ®µä½ä½“ç³»
- æ˜Ÿçº§è®¡ç®—è§„åˆ™
- æ™‹å‡æ–‡æ¡ˆ

---

## ä¸ƒã€çƒŸç˜¾è®°å½•ç³»ç»Ÿ

ï¼ˆæ­¤éƒ¨åˆ†å†…å®¹ä¸ä¹‹å‰ PRD ä¸€è‡´ï¼Œç•¥ï¼‰

è¯¦ç»†å†…å®¹å‚è€ƒï¼š
- çƒŸç˜¾è®°å½•è§„åˆ™
- æ•°æ®å¯è§†åŒ–
- æ—¶æ®µåˆ†å¸ƒç»Ÿè®¡

---

## å…«ã€æ’è¡Œæ¦œç³»ç»Ÿ

ï¼ˆæ­¤éƒ¨åˆ†å†…å®¹å·²æ›´æ–°ï¼ŒåŒ…å«åœ°å€è¯†åˆ«ï¼‰

è¯¦ç»†å†…å®¹å‚è€ƒå‰æ–‡"åœ°å€è¯†åˆ«"éƒ¨åˆ†

---

## ä¹ã€AI åŠ©æ‰‹ç³»ç»Ÿ

### 9.1 DeepSeek æœ¬åœ°éƒ¨ç½²

#### 9.1.1 éƒ¨ç½²æ–¹æ¡ˆ

**é€‰æ‹© DeepSeek çš„ç†ç”±**
- å¼€æºå…è´¹ï¼Œå¯æœ¬åœ°éƒ¨ç½²
- æ€§èƒ½æ¥è¿‘ GPT-3.5ï¼Œæˆæœ¬æä½
- æ”¯æŒä¸­æ–‡å¯¹è¯ï¼Œé€‚åˆå›½å†…ç”¨æˆ·
- éƒ¨ç½²ç®€å•ï¼Œæ”¯æŒ Docker

#### 9.1.2 æœåŠ¡å™¨é…ç½®

**æ¨èé…ç½®**

| é¡¹ç›® | é…ç½® |
|------|------|
| CPU | 8 æ ¸åŠä»¥ä¸Š |
| å†…å­˜ | 16GB åŠä»¥ä¸Š |
| æ˜¾å¡ | NVIDIA GPUï¼ˆæ˜¾å­˜ 8GB+ï¼‰å¯é€‰ |
| ç¡¬ç›˜ | SSD 100GB+ |
| å¸¦å®½ | 10Mbps+ |

#### 9.1.3 Docker éƒ¨ç½²

**docker-compose.yml**

```yaml
version: '3.8'

services:
  deepseek:
    image: deepseek/deepseek-coder:latest
    container_name: deepseek-ai
    ports:
      - "8000:8000"
    environment:
      - MODEL_NAME=deepseek-chat
      - MAX_TOKENS=2048
      - TEMPERATURE=0.7
    volumes:
      - ./models:/models
      - ./cache:/cache
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # API æœåŠ¡ï¼ˆå°è£… DeepSeekï¼‰
  ai-api:
    build: ./ai-service
    container_name: zxo-ai-api
    ports:
      - "3001:3001"
    environment:
      - DEEPSEEK_URL=http://deepseek:8000
      - REDIS_URL=redis://redis:6379
    depends_on:
      - deepseek
      - redis
    restart: unless-stopped
```

#### 9.1.4 AI æœåŠ¡å°è£…

**ai-service/server.js**

```typescript
import express from 'express';
import axios from 'axios';
import Redis from 'ioredis';

const app = express();
const redis = new Redis(process.env.REDIS_URL);

app.use(express.json());

// DeepSeek API é…ç½®
const DEEPSEEK_URL = process.env.DEEPSEEK_URL || 'http://localhost:8000';

// ç³»ç»Ÿæç¤ºè¯
const SYSTEM_PROMPT = `ä½ æ˜¯ ZXO æˆ’çƒŸåº”ç”¨çš„ä¸“ä¸šæˆ’çƒŸè¾…å¯¼åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š

1. **æä¾›ç§‘å­¦ã€å®ç”¨çš„æˆ’çƒŸå»ºè®®**
   - åŸºäºåŒ»å­¦å’Œå¿ƒç†å­¦çŸ¥è¯†
   - é’ˆå¯¹ä¸åŒé˜¶æ®µï¼ˆæˆ’çƒŸåˆæœŸã€å›°éš¾æœŸã€ç¨³å®šæœŸï¼‰ç»™å‡ºå·®å¼‚åŒ–å»ºè®®
   
2. **é¼“åŠ±ç”¨æˆ·åšæŒæˆ’çƒŸ**
   - ç§¯ææ­£é¢çš„è¯­æ°”
   - å¼ºè°ƒå·²å–å¾—çš„è¿›æ­¥
   - ç»™äºˆæƒ…æ„Ÿæ”¯æŒ

3. **è§£ç­”æˆ’çƒŸç›¸å…³ç–‘é—®**
   - ç”Ÿç†ååº”ï¼ˆæˆ’æ–­ç—‡çŠ¶ï¼‰
   - å¿ƒç†ä¾èµ–
   - åº”å¯¹ç­–ç•¥
   - å¥åº·æ¢å¤è¿›ç¨‹

4. **åˆ†æçƒŸç˜¾æ¨¡å¼**
   - æ ¹æ®ç”¨æˆ·çš„çƒŸç˜¾è®°å½•æ•°æ®
   - è¯†åˆ«é«˜å±æ—¶æ®µå’Œè§¦å‘åœºæ™¯
   - æä¾›ä¸ªæ€§åŒ–åº”å¯¹æ–¹æ¡ˆ

**æ³¨æ„äº‹é¡¹ï¼š**
- ä¿æŒä¸“ä¸šã€å‹å–„ã€è€å¿ƒçš„è¯­æ°”
- é¿å…åŒ»ç–—è¯Šæ–­ï¼Œå»ºè®®å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿ
- å…³æ³¨ç”¨æˆ·æƒ…ç»ªï¼Œç»™äºˆå¿ƒç†æ”¯æŒ
- å›ç­”ç®€æ´æ˜äº†ï¼Œåˆ†ç‚¹å‘ˆç°
- é€‚å½“ä½¿ç”¨emojiå¢å¼ºäº²å’ŒåŠ›

**å›ç­”æ ¼å¼ï¼š**
- å…ˆè¡¨è¾¾ç†è§£å’Œé¼“åŠ±
- å†ç»™å‡ºå…·ä½“å»ºè®®
- æœ€åæ€»ç»“è¦ç‚¹`;

// POST /api/chat
app.post('/api/chat', async (req, res) => {
  const { message, userId, conversationId, userContext } = req.body;
  
  try {
    // 1. è·å–å¯¹è¯å†å²
    const historyKey = `ai:conversation:${conversationId || userId}`;
    const historyStr = await redis.get(historyKey);
    const history = historyStr ? JSON.parse(historyStr) : [];
    
    // 2. æ„å»ºä¸ªæ€§åŒ–ä¸Šä¸‹æ–‡
    let contextPrompt = '';
    if (userContext) {
      contextPrompt = `
ç”¨æˆ·å½“å‰çŠ¶æ€ï¼š
- æˆ’çƒŸå¤©æ•°ï¼š${userContext.totalDays} å¤©
- è¿ç»­å¤©æ•°ï¼š${userContext.consecutiveDays} å¤©
- å½“å‰æ®µä½ï¼š${userContext.currentRank}
- å¸çƒŸå¹´é™ï¼š${userContext.smokingYears}
- æ¯æ—¥å¸çƒŸé‡ï¼š${userContext.dailyAmount} æ ¹
- æœ€è¿‘7å¤©çƒŸç˜¾è®°å½•ï¼š${userContext.recentCravings || 0} æ¬¡

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œç»™å‡ºä¸ªæ€§åŒ–å»ºè®®ã€‚
`;
    }
    
    // 3. æ„å»ºæ¶ˆæ¯åˆ—è¡¨
    const messages = [
      { role: 'system', content: SYSTEM_PROMPT },
      ...history,
      { role: 'user', content: contextPrompt + message }
    ];
    
    // 4. è°ƒç”¨ DeepSeek API
    const startTime = Date.now();
    
    const response = await axios.post(`${DEEPSEEK_URL}/v1/chat/completions`, {
      model: 'deepseek-chat',
      messages,
      max_tokens: 500,
      temperature: 0.7,
      stream: false
    });
    
    const aiResponse = response.data.choices[0].message.content;
    const tokensUsed = response.data.usage.total_tokens;
    const responseTime = Date.now() - startTime;
    
    // 5. æ›´æ–°å¯¹è¯å†å²ï¼ˆä¿ç•™æœ€è¿‘10æ¡ï¼‰
    history.push(
      { role: 'user', content: message },
      { role: 'assistant', content: aiResponse }
    );
    
    const recentHistory = history.slice(-20); // ä¿ç•™æœ€è¿‘ 10 è½®å¯¹è¯
    await redis.setex(historyKey, 86400, JSON.stringify(recentHistory)); // 24å°æ—¶è¿‡æœŸ
    
    // 6. ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå¼‚æ­¥ï¼‰
    saveConversation({
      userId,
      conversationId: conversationId || `conv_${Date.now()}_${userId}`,
      userMessage: message,
      aiResponse,
      tokensUsed,
      responseTimeMs: responseTime
    });
    
    res.json({
      code: 200,
      data: {
        response: aiResponse,
        conversationId: conversationId || `conv_${Date.now()}_${userId}`,
        tokensUsed,
        responseTime
      }
    });
    
  } catch (error) {
    console.error('AI å¯¹è¯å¤±è´¥', error);
    res.status(500).json({ code: 500, message: 'AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨' });
  }
});

// æ¸…ç©ºå¯¹è¯å†å²
app.delete('/api/conversation/:conversationId', async (req, res) => {
  const { conversationId } = req.params;
  await redis.del(`ai:conversation:${conversationId}`);
  res.json({ code: 200, message: 'å¯¹è¯å†å²å·²æ¸…ç©º' });
});

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

app.listen(3001, () => {
  console.log('AI æœåŠ¡å·²å¯åŠ¨: http://localhost:3001');
});

// å¼‚æ­¥ä¿å­˜å¯¹è¯åˆ°æ•°æ®åº“
async function saveConversation(data) {
  try {
    // è°ƒç”¨ä¸» API æœåŠ¡ä¿å­˜
    await axios.post('http://api:3000/internal/ai/conversations', data);
  } catch (error) {
    console.error('ä¿å­˜å¯¹è¯å¤±è´¥', error);
  }
}
```

#### 9.1.5 æç¤ºè¯ä¼˜åŒ–

**åœºæ™¯åŒ–æç¤ºè¯**

```typescript
const SCENARIO_PROMPTS = {
  // çƒŸç˜¾å‘ä½œ
  craving: `ç”¨æˆ·ç°åœ¨çƒŸç˜¾å‘ä½œï¼Œæƒ…ç»ªå¯èƒ½ç„¦è™‘æˆ–çƒ¦èºã€‚è¯·ï¼š
1. å…ˆè¡¨è¾¾ç†è§£å’Œå®‰æ…°
2. ç»™å‡º3-5ä¸ªç«‹å³å¯è¡Œçš„åº”å¯¹æ–¹æ³•
3. é¼“åŠ±ç”¨æˆ·åšæŒï¼Œå¼ºè°ƒè¿™æ˜¯æš‚æ—¶çš„
4. å»ºè®®è®°å½•çƒŸç˜¾è§¦å‘å› ç´ `,

  // åˆæ¬¡æˆ’çƒŸ
  beginner: `ç”¨æˆ·åˆšå¼€å§‹æˆ’çƒŸï¼ˆ1-7å¤©ï¼‰ï¼Œæ­£å¤„äºæœ€å›°éš¾çš„é˜¶æ®µã€‚è¯·ï¼š
1. ç¥è´ºç”¨æˆ·è¿ˆå‡ºç¬¬ä¸€æ­¥
2. è§£é‡Šå‰7å¤©çš„å¸¸è§æˆ’æ–­ç—‡çŠ¶
3. æä¾›åº”å¯¹æˆ’æ–­ç—‡çŠ¶çš„æ–¹æ³•
4. é¼“åŠ±åšæŒåº¦è¿‡å…³é”®æœŸ`,

  // å¤å¸é£é™©
  relapse_risk: `ç”¨æˆ·å¯èƒ½æœ‰å¤å¸é£é™©ï¼ˆæƒ…ç»ªä½è½ã€å‹åŠ›å¤§ç­‰ï¼‰ã€‚è¯·ï¼š
1. åŒç†å¿ƒç†è§£ç”¨æˆ·çš„å¤„å¢ƒ
2. å¸®åŠ©åˆ†æå¤å¸çš„åæœ
3. å›é¡¾å·²å–å¾—çš„æˆæœ
4. æä¾›å‹åŠ›ç®¡ç†å»ºè®®
5. é¼“åŠ±å¯»æ±‚æ”¯æŒ`,

  // é•¿æœŸæˆ’çƒŸ
  veteran: `ç”¨æˆ·å·²åšæŒè¾ƒé•¿æ—¶é—´ï¼ˆ90å¤©+ï¼‰ï¼Œè¿›å…¥ç¨³å®šæœŸã€‚è¯·ï¼š
1. ç¥è´ºç”¨æˆ·å–å¾—çš„æˆå°±
2. æé†’ä¿æŒè­¦æƒ•ï¼Œé¿å…æ¾æ‡ˆ
3. å»ºè®®å…³æ³¨é•¿æœŸå¥åº·æ¢å¤
4. é¼“åŠ±åˆ†äº«ç»éªŒï¼Œå¸®åŠ©ä»–äºº`
};

// æ ¹æ®ç”¨æˆ·çŠ¶æ€é€‰æ‹©æç¤ºè¯
function getContextualPrompt(userContext) {
  const { totalDays, recentCravings, consecutiveDays } = userContext;
  
  if (recentCravings > 3) {
    return SCENARIO_PROMPTS.craving;
  } else if (totalDays <= 7) {
    return SCENARIO_PROMPTS.beginner;
  } else if (consecutiveDays === 0 && totalDays > 7) {
    return SCENARIO_PROMPTS.relapse_risk;
  } else if (totalDays >= 90) {
    return SCENARIO_PROMPTS.veteran;
  }
  
  return '';
}
```

#### 9.1.6 æˆæœ¬æ§åˆ¶

**Token é™åˆ¶ç­–ç•¥**

```typescript
// æ¯æ—¥ Token é™é¢
const DAILY_TOKEN_LIMITS = {
  free: 0,          // å…è´¹ç”¨æˆ·æ— AIæƒé™
  vip: 10000,       // VIP æ¯æ—¥ 10k tokensï¼ˆçº¦20æ¬¡å¯¹è¯ï¼‰
  ai: 100000        // AI ä¼šå‘˜æ¯æ—¥ 100k tokensï¼ˆçº¦200æ¬¡å¯¹è¯ï¼‰
};

// æ£€æŸ¥ Token é™é¢
async function checkTokenLimit(userId: number, memberType: string): Promise<boolean> {
  const today = new Date().toISOString().split('T')[0];
  const usageKey = `ai:token_usage:${userId}:${today}`;
  
  const currentUsage = await redis.get(usageKey);
  const usage = currentUsage ? parseInt(currentUsage) : 0;
  
  const limit = DAILY_TOKEN_LIMITS[memberType];
  
  if (usage >= limit) {
    return false;
  }
  
  return true;
}

// è®°å½• Token ä½¿ç”¨
async function recordTokenUsage(userId: number, tokens: number) {
  const today = new Date().toISOString().split('T')[0];
  const usageKey = `ai:token_usage:${userId}:${today}`;
  
  await redis.incrby(usageKey, tokens);
  await redis.expire(usageKey, 86400); // 24å°æ—¶è¿‡æœŸ
}
```

---

## åã€æ”¯ä»˜ç³»ç»Ÿ

### 10.1 å¾®ä¿¡æ”¯ä»˜æ¥å…¥

#### 10.1.1 åŠŸèƒ½æè¿°

- æ”¯æŒå¾®ä¿¡å°ç¨‹åºæ”¯ä»˜
- æ”¯æŒå¾®ä¿¡ JSAPI æ”¯ä»˜ï¼ˆå…¬ä¼—å·ï¼‰
- å•†å“ç±»å‹ï¼šVIP ä¼šå‘˜ã€AI ä¼šå‘˜ã€è¡¥ç­¾å¡
- è®¢å•ç®¡ç†ï¼šåˆ›å»ºã€æŸ¥è¯¢ã€é€€æ¬¾

#### 10.1.2 å•†å“é…ç½®

```typescript
// å•†å“åˆ—è¡¨
const PRODUCTS = {
  vip_monthly: {
    id: 'vip_monthly',
    name: 'VIP ä¼šå‘˜ï¼ˆæœˆå¡ï¼‰',
    description: 'å…¨å›½æ’å + 4å¤©AIä½“éªŒ',
    price: 9.9,
    durationDays: 30,
    memberType: 'vip'
  },
  
  ai_monthly: {
    id: 'ai_monthly',
    name: 'AI æˆ’çƒŸå†›å¸ˆï¼ˆæœˆå¡ï¼‰',
    description: 'å…¨å›½æ’å + AIæ™ºèƒ½è¾…å¯¼',
    price: 29.9,
    durationDays: 30,
    memberType: 'ai'
  },
  
  ai_yearly: {
    id: 'ai_yearly',
    name: 'AI æˆ’çƒŸå†›å¸ˆï¼ˆå¹´å¡ï¼‰',
    description: 'å…¨å›½æ’å + AIæ™ºèƒ½è¾…å¯¼',
    price: 199,
    durationDays: 365,
    memberType: 'ai'
  },
  
  makeup_card_1: {
    id: 'makeup_card_1',
    name: 'è¡¥ç­¾å¡ï¼ˆ1å¼ ï¼‰',
    description: 'å¯è¡¥ç­¾è¿‡å»ä»»æ„ä¸€å¤©',
    price: 0.99,
    cardCount: 1
  },
  
  makeup_card_5: {
    id: 'makeup_card_5',
    name: 'è¡¥ç­¾å¡ï¼ˆ5å¼ ï¼‰',
    description: 'å¯è¡¥ç­¾è¿‡å»ä»»æ„5å¤©',
    price: 3.99,
    cardCount: 5
  },
  
  makeup_card_10: {
    id: 'makeup_card_10',
    name: 'è¡¥ç­¾å¡ï¼ˆ10å¼ ï¼‰',
    description: 'å¯è¡¥ç­¾è¿‡å»ä»»æ„10å¤©',
    price: 6.99,
    cardCount: 10
  }
};
```

#### 10.1.3 æ”¯ä»˜æµç¨‹

```
ç”¨æˆ·é€‰æ‹©å•†å“
  â†“
ç‚¹å‡»"ç«‹å³è´­ä¹°"
  â†“
å‰ç«¯è°ƒç”¨ç»Ÿä¸€ä¸‹å•æ¥å£
  â†“
åç«¯åˆ›å»ºè®¢å•
  â†“
åç«¯è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ç»Ÿä¸€ä¸‹å•API
  â†“
åç«¯è¿”å›æ”¯ä»˜å‚æ•°
  â†“
å‰ç«¯è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
  â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜
  â†“
å¾®ä¿¡å›è°ƒé€šçŸ¥åç«¯
  â†“
åç«¯éªŒè¯ç­¾å
  â†“
åç«¯å‘æ”¾å•†å“ï¼ˆå¼€é€šä¼šå‘˜/èµ é€è¡¥ç­¾å¡ï¼‰
  â†“
æ›´æ–°è®¢å•çŠ¶æ€
  â†“
å‰ç«¯è½®è¯¢è®¢å•çŠ¶æ€æˆ–æ¥æ”¶å›è°ƒ
  â†“
æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸ
```

#### 10.1.4 å‰ç«¯å®ç°

**å°ç¨‹åºç«¯**

```javascript
// è´­ä¹°å•†å“
async function buyProduct(productId) {
  try {
    // 1. åˆ›å»ºè®¢å•
    const orderRes = await wx.request({
      url: 'https://api.zxo.app/v1/orders/create',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      data: { productId }
    });
    
    const { orderId, paymentParams } = orderRes.data.data;
    
    // 2. è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
    const payRes = await wx.requestPayment({
      timeStamp: paymentParams.timeStamp,
      nonceStr: paymentParams.nonceStr,
      package: paymentParams.package,
      signType: 'RSA',
      paySign: paymentParams.paySign
    });
    
    // 3. æ”¯ä»˜æˆåŠŸï¼ŒæŸ¥è¯¢è®¢å•çŠ¶æ€
    await checkOrderStatus(orderId);
    
    wx.showToast({ title: 'è´­ä¹°æˆåŠŸ' });
    
  } catch (error) {
    if (error.errMsg === 'requestPayment:fail cancel') {
      wx.showToast({ title: 'å·²å–æ¶ˆæ”¯ä»˜', icon: 'none' });
    } else {
      wx.showToast({ title: 'æ”¯ä»˜å¤±è´¥', icon: 'none' });
    }
  }
}

// æŸ¥è¯¢è®¢å•çŠ¶æ€
async function checkOrderStatus(orderId) {
  let retries = 0;
  const maxRetries = 10;
  
  return new Promise((resolve, reject) => {
    const timer = setInterval(async () => {
      try {
        const res = await wx.request({
          url: `https://api.zxo.app/v1/orders/${orderId}`,
          header: {
            'Authorization': `Bearer ${wx.getStorageSync('token')}`
          }
        });
        
        const { status } = res.data.data;
        
        if (status === 'paid') {
          clearInterval(timer);
          resolve(true);
        } else if (status === 'failed' || retries >= maxRetries) {
          clearInterval(timer);
          reject(new Error('æ”¯ä»˜å¤±è´¥'));
        }
        
        retries++;
      } catch (error) {
        clearInterval(timer);
        reject(error);
      }
    }, 2000); // æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡
  });
}
```

**Web ç«¯ï¼ˆJSAPI æ”¯ä»˜ï¼‰**

```typescript
// è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
function invokeWechatPay(paymentParams: any) {
  if (typeof WeixinJSBridge === 'undefined') {
    alert('è¯·åœ¨å¾®ä¿¡ä¸­æ‰“å¼€');
    return;
  }
  
  WeixinJSBridge.invoke('getBrandWCPayRequest', {
    appId: paymentParams.appId,
    timeStamp: paymentParams.timeStamp,
    nonceStr: paymentParams.nonceStr,
    package: paymentParams.package,
    signType: 'RSA',
    paySign: paymentParams.paySign
  }, (res: any) => {
    if (res.err_msg === 'get_brand_wcpay_request:ok') {
      // æ”¯ä»˜æˆåŠŸ
      checkOrderStatus(paymentParams.orderId);
    } else {
      // æ”¯ä»˜å¤±è´¥æˆ–å–æ¶ˆ
      alert('æ”¯ä»˜å¤±è´¥');
    }
  });
}
```

#### 10.1.5 åç«¯å®ç°

**æ•°æ®åº“è¡¨**

```sql
-- è®¢å•è¡¨
CREATE TABLE orders (
  id SERIAL PRIMARY KEY,
  order_no VARCHAR(64) UNIQUE NOT NULL,      -- è®¢å•å·
  user_id INT REFERENCES users(id),
  
  -- å•†å“ä¿¡æ¯
  product_id VARCHAR(50) NOT NULL,
  product_name VARCHAR(100) NOT NULL,
  product_price DECIMAL(10, 2) NOT NULL,
  
  -- æ”¯ä»˜ä¿¡æ¯
  payment_method VARCHAR(20) DEFAULT 'wechat', -- 'wechat', 'alipay'
  transaction_id VARCHAR(128),                 -- å¾®ä¿¡äº¤æ˜“å·
  prepay_id VARCHAR(128),                      -- é¢„æ”¯ä»˜ID
  
  -- è®¢å•çŠ¶æ€
  status VARCHAR(20) DEFAULT 'pending',        -- 'pending', 'paid', 'failed', 'refunded'
  paid_at TIMESTAMP,
  refunded_at TIMESTAMP,
  
  -- å•†å“å‘æ”¾
  delivered BOOLEAN DEFAULT FALSE,
  delivered_at TIMESTAMP,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_order_no ON orders(order_no);
CREATE INDEX idx_orders_status ON orders(status);
```

**ç»Ÿä¸€ä¸‹å•æ¥å£**

```typescript
import crypto from 'crypto';
import axios from 'axios';

const WECHAT_CONFIG = {
  appId: process.env.WECHAT_APP_ID,
  mchId: process.env.WECHAT_MCH_ID,
  apiKey: process.env.WECHAT_API_KEY,
  notifyUrl: 'https://api.zxo.app/v1/payment/wechat/notify'
};

// POST /api/v1/orders/create
async function createOrder(req, res) {
  const userId = req.user.id;
  const { productId } = req.body;
  
  try {
    // 1. è·å–å•†å“ä¿¡æ¯
    const product = PRODUCTS[productId];
    if (!product) {
      return res.status(400).json({ code: 400, message: 'å•†å“ä¸å­˜åœ¨' });
    }
    
    // 2. åˆ›å»ºè®¢å•
    const orderNo = generateOrderNo();
    const order = await db.orders.create({
      orderNo,
      userId,
      productId: product.id,
      productName: product.name,
      productPrice: product.price,
      paymentMethod: 'wechat',
      status: 'pending'
    });
    
    // 3. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ç»Ÿä¸€ä¸‹å•
    const prepayResult = await wechatUnifiedOrder({
      orderNo,
      totalFee: Math.round(product.price * 100), // è½¬ä¸ºåˆ†
      body: product.name,
      openid: req.user.openid
    });
    
    // 4. æ›´æ–°è®¢å•
    await db.orders.update(order.id, {
      prepayId: prepayResult.prepay_id
    });
    
    // 5. ç”Ÿæˆæ”¯ä»˜å‚æ•°ï¼ˆå‰ç«¯è°ƒèµ·æ”¯ä»˜ç”¨ï¼‰
    const paymentParams = generatePaymentParams(prepayResult.prepay_id);
    
    res.json({
      code: 200,
      data: {
        orderId: order.id,
        orderNo,
        paymentParams
      }
    });
    
  } catch (error) {
    logger.error('åˆ›å»ºè®¢å•å¤±è´¥', error);
    res.status(500).json({ code: 500, message: 'åˆ›å»ºè®¢å•å¤±è´¥' });
  }
}

// å¾®ä¿¡ç»Ÿä¸€ä¸‹å•
async function wechatUnifiedOrder(params: {
  orderNo: string;
  totalFee: number;
  body: string;
  openid: string;
}) {
  const { orderNo, totalFee, body, openid } = params;
  
  const data = {
    appid: WECHAT_CONFIG.appId,
    mch_id: WECHAT_CONFIG.mchId,
    nonce_str: crypto.randomBytes(16).toString('hex'),
    body,
    out_trade_no: orderNo,
    total_fee: totalFee,
    spbill_create_ip: '127.0.0.1',
    notify_url: WECHAT_CONFIG.notifyUrl,
    trade_type: 'JSAPI',
    openid
  };
  
  // ç”Ÿæˆç­¾å
  data.sign = generateWechatSign(data);
  
  // è½¬æ¢ä¸º XML
  const xml = jsonToXml(data);
  
  // è°ƒç”¨å¾®ä¿¡ API
  const response = await axios.post(
    'https://api.mch.weixin.qq.com/pay/unifiedorder',
    xml,
    { headers: { 'Content-Type': 'application/xml' } }
  );
  
  const result = xmlToJson(response.data);
  
  if (result.return_code !== 'SUCCESS' || result.result_code !== 'SUCCESS') {
    throw new Error('å¾®ä¿¡ä¸‹å•å¤±è´¥');
  }
  
  return result;
}

// ç”Ÿæˆæ”¯ä»˜å‚æ•°
function generatePaymentParams(prepayId: string) {
  const params = {
    appId: WECHAT_CONFIG.appId,
    timeStamp: Math.floor(Date.now() / 1000).toString(),
    nonceStr: crypto.randomBytes(16).toString('hex'),
    package: `prepay_id=${prepayId}`,
    signType: 'RSA'
  };
  
  params.paySign = generateWechatSign(params);
  
  return params;
}

// ç”Ÿæˆå¾®ä¿¡ç­¾å
function generateWechatSign(data: any): string {
  const keys = Object.keys(data).sort();
  const stringA = keys
    .filter(key => data[key] && key !== 'sign')
    .map(key => `${key}=${data[key]}`)
    .join('&');
  
  const stringSignTemp = `${stringA}&key=${WECHAT_CONFIG.apiKey}`;
  
  return crypto.createHash('md5').update(stringSignTemp).digest('hex').toUpperCase();
}

// ç”Ÿæˆè®¢å•å·
function generateOrderNo(): string {
  const timestamp = Date.now();
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  return `ZXO${timestamp}${random}`;
}
```

**æ”¯ä»˜å›è°ƒå¤„ç†**

```typescript
// POST /api/v1/payment/wechat/notify
async function wechatPaymentNotify(req, res) {
  try {
    // 1. è§£æ XML
    const data = xmlToJson(req.body);
    
    // 2. éªŒè¯ç­¾å
    const sign = data.sign;
    delete data.sign;
    const calculatedSign = generateWechatSign(data);
    
    if (sign !== calculatedSign) {
      logger.error('ç­¾åéªŒè¯å¤±è´¥');
      return res.send(jsonToXml({
        return_code: 'FAIL',
        return_msg: 'ç­¾åéªŒè¯å¤±è´¥'
      }));
    }
    
    // 3. æ£€æŸ¥æ”¯ä»˜ç»“æœ
    if (data.return_code !== 'SUCCESS' || data.result_code !== 'SUCCESS') {
      logger.error('æ”¯ä»˜å¤±è´¥', data);
      return res.send(jsonToXml({
        return_code: 'FAIL',
        return_msg: 'æ”¯ä»˜å¤±è´¥'
      }));
    }
    
    const orderNo = data.out_trade_no;
    const transactionId = data.transaction_id;
    
    // 4. æŸ¥è¯¢è®¢å•
    const order = await db.orders.findOne({ where: { orderNo } });
    
    if (!order) {
      logger.error('è®¢å•ä¸å­˜åœ¨', orderNo);
      return res.send(jsonToXml({
        return_code: 'FAIL',
        return_msg: 'è®¢å•ä¸å­˜åœ¨'
      }));
    }
    
    // 5. æ£€æŸ¥è®¢å•çŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤å›è°ƒï¼‰
    if (order.status === 'paid') {
      return res.send(jsonToXml({
        return_code: 'SUCCESS',
        return_msg: 'OK'
      }));
    }
    
    // 6. æ›´æ–°è®¢å•çŠ¶æ€
    await db.orders.update(order.id, {
      status: 'paid',
      transactionId,
      paidAt: new Date()
    });
    
    // 7. å‘æ”¾å•†å“ï¼ˆå¼‚æ­¥ï¼‰
    await deliverProduct(order);
    
    // 8. è¿”å›æˆåŠŸ
    res.send(jsonToXml({
      return_code: 'SUCCESS',
      return_msg: 'OK'
    }));
    
  } catch (error) {
    logger.error('æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥', error);
    res.send(jsonToXml({
      return_code: 'FAIL',
      return_msg: 'å¤„ç†å¤±è´¥'
    }));
  }
}

// å‘æ”¾å•†å“
async function deliverProduct(order: Order) {
  const product = PRODUCTS[order.productId];
  
  try {
    if (product.memberType) {
      // å¼€é€šä¼šå‘˜
      const expiryDate = new Date();
      expiryDate.setDate(expiryDate.getDate() + product.durationDays);
      
      await db.users.update(order.userId, {
        memberType: product.memberType,
        memberExpiryAt: expiryDate,
        ...(product.memberType === 'vip' ? { vipActivatedAt: new Date() } : {}),
        ...(product.memberType === 'ai' ? { aiActivatedAt: new Date() } : {})
      });
      
    } else if (product.cardCount) {
      // èµ é€è¡¥ç­¾å¡
      const user = await db.users.findById(order.userId);
      await db.users.update(order.userId, {
        makeupCards: user.makeupCards + product.cardCount
      });
    }
    
    // æ›´æ–°è®¢å•
    await db.orders.update(order.id, {
      delivered: true,
      deliveredAt: new Date()
    });
    
    // åˆ é™¤ç”¨æˆ·ç¼“å­˜
    await redis.del(`user:${order.userId}`);
    
    logger.info('å•†å“å‘æ”¾æˆåŠŸ', { orderId: order.id, userId: order.userId });
    
  } catch (error) {
    logger.error('å•†å“å‘æ”¾å¤±è´¥', error);
    // å¯ä»¥é‡è¯•æˆ–äººå·¥å¤„ç†
  }
}
```

#### 10.1.6 è®¢å•æŸ¥è¯¢

```typescript
// GET /api/v1/orders/:orderId
async function getOrder(req, res) {
  const userId = req.user.id;
  const { orderId } = req.params;
  
  try {
    const order = await db.orders.findOne({
      where: { id: orderId, userId }
    });
    
    if (!order) {
      return res.status(404).json({ code: 404, message: 'è®¢å•ä¸å­˜åœ¨' });
    }
    
    res.json({
      code: 200,
      data: {
        id: order.id,
        orderNo: order.orderNo,
        productName: order.productName,
        productPrice: order.productPrice,
        status: order.status,
        paidAt: order.paidAt,
        delivered: order.delivered
      }
    });
    
  } catch (error) {
    logger.error('æŸ¥è¯¢è®¢å•å¤±è´¥', error);
    res.status(500).json({ code: 500, message: 'æŸ¥è¯¢å¤±è´¥' });
  }
}

// GET /api/v1/orders
async function getUserOrders(req, res) {
  const userId = req.user.id;
  const { page = 1, limit = 20 } = req.query;
  
  try {
    const orders = await db.orders.findAll({
      where: { userId },
      order: [['created_at', 'DESC']],
      limit,
      offset: (page - 1) * limit
    });
    
    res.json({
      code: 200,
      data: { orders }
    });
    
  } catch (error) {
    logger.error('æŸ¥è¯¢è®¢å•åˆ—è¡¨å¤±è´¥', error);
    res.status(500).json({ code: 500, message: 'æŸ¥è¯¢å¤±è´¥' });
  }
}
```

---

## åä¸€ã€æ•°æ®æŠ¥å‘Š

ï¼ˆæ­¤éƒ¨åˆ†å†…å®¹ä¸ä¹‹å‰ PRD ä¸€è‡´ï¼Œç•¥ï¼‰

---

## åäºŒã€åˆ†äº«ç³»ç»Ÿ

ï¼ˆæ­¤éƒ¨åˆ†å†…å®¹ä¸ä¹‹å‰ PRD ä¸€è‡´ï¼Œç•¥ï¼‰

---

## åä¸‰ã€æŠ€æœ¯æ¶æ„

### 13.1 å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| React | UI æ¡†æ¶ |
| TypeScript | ç±»å‹å®‰å…¨ |
| Tailwind CSS v4.0 | æ ·å¼æ¡†æ¶ |
| Motion (Framer Motion) | åŠ¨ç”»åº“ |
| Recharts | å›¾è¡¨åº“ |
| Lucide React | å›¾æ ‡åº“ |
| Sonner | Toast é€šçŸ¥ |

### 13.2 åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| Node.js + Express/NestJS | åç«¯æ¡†æ¶ |
| TypeScript | ç±»å‹å®‰å…¨ |
| PostgreSQL | ä¸»æ•°æ®åº“ |
| Redis | ç¼“å­˜ + æ’è¡Œæ¦œ |
| Bull | æ¶ˆæ¯é˜Ÿåˆ— |
| JWT | èº«ä»½è®¤è¯ |
| OSS (S3/é˜¿é‡Œäº‘) | å¯¹è±¡å­˜å‚¨ |
| Docker | å®¹å™¨åŒ–éƒ¨ç½² |

### 13.3 AI æœåŠ¡

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| DeepSeek | æœ¬åœ°éƒ¨ç½² AI æ¨¡å‹ |
| Docker | AI æœåŠ¡å®¹å™¨åŒ– |
| NVIDIA GPU | åŠ é€Ÿæ¨ç†ï¼ˆå¯é€‰ï¼‰ |

### 13.4 å¾®ä¿¡ç”Ÿæ€

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| å¾®ä¿¡å°ç¨‹åº SDK | å°ç¨‹åºå¼€å‘ |
| å¾®ä¿¡æ”¯ä»˜ API | æ”¯ä»˜åŠŸèƒ½ |
| å¾®ä¿¡ç™»å½• API | ç”¨æˆ·è®¤è¯ |
| é«˜å¾·åœ°å›¾ API | åœ°å€è¯†åˆ« |

---

## åå››ã€æ•°æ®åº“è®¾è®¡

ï¼ˆå®Œæ•´è¡¨ç»“æ„è¯·å‚è€ƒã€Šåç«¯æŠ€æœ¯æ–‡æ¡£ã€‹ç¬¬ä¸‰ç« ï¼‰

æ ¸å¿ƒè¡¨ï¼š
1. users - ç”¨æˆ·è¡¨
2. user_settings - ç”¨æˆ·è®¾ç½®è¡¨
3. check_in_records - æ‰“å¡è®°å½•è¡¨
4. craving_records - çƒŸç˜¾è®°å½•è¡¨
5. redeem_codes - å…‘æ¢ç è¡¨
6. orders - è®¢å•è¡¨
7. rankings - æ’è¡Œæ¦œç¼“å­˜è¡¨
8. ai_conversations - AI å¯¹è¯è®°å½•è¡¨

---

## åäº”ã€API æ¥å£è®¾è®¡

ï¼ˆå®Œæ•´æ¥å£åˆ—è¡¨è¯·å‚è€ƒã€Šåç«¯æŠ€æœ¯æ–‡æ¡£ã€‹ç¬¬å››ç« ï¼‰

æ ¸å¿ƒæ¥å£ï¼š
- è®¤è¯æ¨¡å—ï¼šå¾®ä¿¡ç™»å½•ã€Token åˆ·æ–°
- ç”¨æˆ·æ¨¡å—ï¼šè·å–/æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€ä¸Šä¼ å¤´åƒã€åœ°å€è¯†åˆ«
- æ‰“å¡æ¨¡å—ï¼šæ‰“å¡ã€è¡¥ç­¾ã€æŸ¥è¯¢è®°å½•
- çƒŸç˜¾æ¨¡å—ï¼šè®°å½•çƒŸç˜¾ã€æŸ¥è¯¢ç»Ÿè®¡
- æ’è¡Œæ¦œæ¨¡å—ï¼šè·å–æ’åã€æˆ‘çš„æ’å
- æ”¯ä»˜æ¨¡å—ï¼šåˆ›å»ºè®¢å•ã€æ”¯ä»˜å›è°ƒã€æŸ¥è¯¢è®¢å•
- AI æ¨¡å—ï¼šå¯¹è¯ã€æ¸…ç©ºå†å²

---

## åå…­ã€éƒ¨ç½²æ–¹æ¡ˆ

### 16.1 å¼€å‘ç¯å¢ƒ

```bash
# å‰ç«¯
cd frontend
npm install
npm run dev

# åç«¯
cd backend
npm install
npm run dev

# AI æœåŠ¡
cd ai-service
docker-compose up -d

# æ•°æ®åº“
docker run -d -p 5432:5432 \
  -e POSTGRES_DB=zxo \
  -e POSTGRES_USER=zxo \
  -e POSTGRES_PASSWORD=password \
  postgres:15-alpine

# Redis
docker run -d -p 6379:6379 redis:7-alpine
```

### 16.2 ç”Ÿäº§ç¯å¢ƒ

**æœåŠ¡å™¨é…ç½®**

| æœåŠ¡ | é…ç½® | æ•°é‡ |
|------|------|------|
| API Server | 4C8G | 2 å° |
| PostgreSQL | 4C8G | 1 ä¸» + 1 ä» |
| Redis | 2C4G | 3 å°ï¼ˆå“¨å…µï¼‰ |
| AI Server | 8C16G + GPU | 1 å° |
| Nginx | 2C2G | 1 å° |

**Docker Composeï¼ˆå®Œæ•´ï¼‰**

```yaml
version: '3.8'

services:
  # API æœåŠ¡
  api:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=postgres
      - REDIS_HOST=redis
      - AI_SERVICE_URL=http://ai-service:3001
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  # AI æœåŠ¡
  ai-service:
    build: ./ai-service
    ports:
      - "3001:3001"
    environment:
      - DEEPSEEK_URL=http://deepseek:8000
      - REDIS_HOST=redis
    depends_on:
      - deepseek
      - redis
    restart: unless-stopped

  # DeepSeek
  deepseek:
    image: deepseek/deepseek-coder:latest
    ports:
      - "8000:8000"
    volumes:
      - ./models:/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # PostgreSQL
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=zxo
      - POSTGRES_USER=zxo
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  # Redis
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # Nginx
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
      - ./frontend/dist:/usr/share/nginx/html
    depends_on:
      - api
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

---

## é™„å½•

### A. å¼€å‘ä¼˜å…ˆçº§

**P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»å®Œæˆï¼‰**
- [ ] å¾®ä¿¡å°ç¨‹åºç™»å½•
- [ ] æ‰“å¡ç³»ç»Ÿï¼ˆå«è¡¥ç­¾ï¼‰
- [ ] æ®µä½è®¡ç®—
- [ ] å¾®ä¿¡æ”¯ä»˜æ¥å…¥
- [ ] æ•°æ®åº“åˆå§‹åŒ–
- [ ] API æ¥å£å¼€å‘

**P1ï¼ˆé‡è¦åŠŸèƒ½ï¼Œå°½å¿«å®Œæˆï¼‰**
- [ ] ä¿®æ”¹å¤´åƒæ˜µç§°
- [ ] åœ°å€è¯†åˆ«
- [ ] DeepSeek éƒ¨ç½²
- [ ] æ’è¡Œæ¦œç³»ç»Ÿ
- [ ] çƒŸç˜¾è®°å½•
- [ ] åˆ†äº«æµ·æŠ¥

**P2ï¼ˆå¢å¼ºåŠŸèƒ½ï¼Œåç»­ä¼˜åŒ–ï¼‰**
- [ ] AI æç¤ºè¯ä¼˜åŒ–
- [ ] å¥åº·æŠ¥å‘Š
- [ ] ç¼“å­˜ç³»ç»Ÿä¼˜åŒ–
- [ ] æ€§èƒ½ç›‘æ§

**P3ï¼ˆå¯é€‰åŠŸèƒ½ï¼Œé•¿æœŸè§„åˆ’ï¼‰**
- [ ] ç¤¾äº¤åŠŸèƒ½
- [ ] æˆå°±ç³»ç»Ÿ
- [ ] ä¸ªæ€§åŒ–æ¨è

### B. ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env.production

# åº”ç”¨é…ç½®
NODE_ENV=production
PORT=3000
API_BASE_URL=https://api.zxo.app

# æ•°æ®åº“
DB_HOST=your_db_host
DB_PORT=5432
DB_NAME=zxo
DB_USER=zxo
DB_PASSWORD=your_password

# Redis
REDIS_HOST=your_redis_host
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# JWT
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=7d

# å¾®ä¿¡å°ç¨‹åº
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret

# å¾®ä¿¡æ”¯ä»˜
WECHAT_MCH_ID=your_mch_id
WECHAT_API_KEY=your_api_key
WECHAT_CERT_PATH=/path/to/cert.pem
WECHAT_KEY_PATH=/path/to/key.pem

# é«˜å¾·åœ°å›¾
AMAP_API_KEY=your_amap_key

# DeepSeek
DEEPSEEK_URL=http://localhost:8000
AI_SERVICE_URL=http://localhost:3001

# OSS
OSS_REGION=cn-beijing
OSS_ACCESS_KEY_ID=your_access_key
OSS_ACCESS_KEY_SECRET=your_secret_key
OSS_BUCKET=zxo-app
CDN_BASE_URL=https://cdn.zxo.app

# çŸ­ä¿¡æœåŠ¡ï¼ˆå¯é€‰ï¼‰
SMS_PROVIDER=aliyun
SMS_ACCESS_KEY=your_sms_key
SMS_SECRET_KEY=your_sms_secret

# ç›‘æ§
SENTRY_DSN=https://xxxxx@sentry.io/xxxxx
```

### C. ä¸Šçº¿æ£€æŸ¥æ¸…å•

**ä¸Šçº¿å‰**
- [ ] æ•°æ®åº“å¤‡ä»½
- [ ] ç¯å¢ƒå˜é‡æ£€æŸ¥
- [ ] SSL è¯ä¹¦é…ç½®
- [ ] å¾®ä¿¡æ”¯ä»˜æµ‹è¯•
- [ ] AI æœåŠ¡æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] å®‰å…¨å®¡è®¡

**ä¸Šçº¿å**
- [ ] ç›‘æ§å‘Šè­¦é…ç½®
- [ ] æ—¥å¿—æ”¶é›†
- [ ] æ•°æ®å¤‡ä»½è®¡åˆ’
- [ ] åº”æ€¥é¢„æ¡ˆ

---

**æ–‡æ¡£ç»“æŸ**

---

## æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ |
|------|------|----------|
| v1.0 | 2025-11-15 | åˆç‰ˆåˆ›å»º |
| v2.0 | 2025-12-01 | åˆ‡æ¢æµ…è‰²ä¸»é¢˜ï¼Œä¼˜åŒ–æƒé™ä½“ç³» |
| v3.0 | 2025-12-01 | æ–°å¢å¾®ä¿¡ç™»å½•ã€æ”¯ä»˜ç³»ç»Ÿã€DeepSeekéƒ¨ç½²ã€åœ°å€è¯†åˆ«ç­‰å®Œæ•´åŠŸèƒ½ |
